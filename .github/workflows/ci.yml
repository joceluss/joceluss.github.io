name: ci 
on:
  push:
    branches:
      - master 
      - main
  pull_request:
    branches:
      - master
      - main

jobs:
  security-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: 3.x
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      - name: Run security checks
        run: |
          ./check-security.sh
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: security-reports/
          retention-days: 30
      - name: Check for critical vulnerabilities
        run: |
          # Fail the build if there are high severity vulnerabilities in our direct dependencies
          python3 -c "
          import json, sys
          try:
              with open('security-reports/pip-audit-report.json', 'r') as f:
                  data = json.load(f)
              critical_vulns = []
              for dep in data['dependencies']:
                  if dep['vulns']:
                      for vuln in dep['vulns']:
                          # Only fail for high severity vulnerabilities in main dependencies
                          if 'mkdocs' in dep['name'].lower() and any(alias.startswith('CVE-') for alias in vuln.get('aliases', [])):
                              critical_vulns.append(f\"{dep['name']}: {vuln['id']}\")
              if critical_vulns:
                  print('❌ Critical vulnerabilities found in main dependencies:')
                  for vuln in critical_vulns:
                      print(f'  - {vuln}')
                  sys.exit(1)
              else:
                  print('✅ No critical vulnerabilities in main dependencies')
          except Exception as e:
              print(f'⚠️  Could not analyze vulnerabilities: {e}')
              # Don't fail the build if we can\\'t analyze - this is a safety net
          "

  deploy:
    runs-on: ubuntu-latest
    needs: security-check
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: 3.x
      - run: pip install mkdocs-material==9.6.19 
      - run: mkdocs gh-deploy --force
